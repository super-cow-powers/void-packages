# Template file for 'texlive-src'
pkgname=texlive-src
version=20200406
revision=1
short_desc="TeX Live Source distribution"
maintainer="David Miall <dm1306@york.ac.uk>"
license="GPL-2"
homepage="http://tug.org/texlive/"
provides="texlive-${version}_${revision}"
conflicts="texlive-*"
archs="i686 x86_64 ppc64*"
create_wrksrc=yes
#make_build_args=""
#make_install_args=""
#conf_files=""
#make_dirs="/var/log/dir 0755 root root"
hostmakedepends="perl"
makedepends="pkg-config freetype-devel libpng-devel poppler-devel icu-devel harfbuzz-devel cairo-devel pixman-devel zziplib-devel libpaper-devel graphite-devel libXmu-devel fontconfig-devel libXaw-devel lesstif-devel"
depends="cairo pixman graphite gd poppler libsigsegv
 zziplib libpng libjpeg-turbo freetype icu harfbuzz wget perl
 ghostscript xz"
short_desc="Texlive 2020 build from source"

distfiles="ftp://tug.org/historic/systems/texlive/2020/texlive-20200406-source.tar.xz>${pkgname}-${version}-${revision}.tar.gz"
checksum=e32f3d08cbbbcf21d8d3f96f2143b64a1f5e4cb01b06b761d6249c8785249078

nocross="I don't have the time to set-up and test cross-building - TODO"

python_version=3

_pdftex="amstex cslatex csplain eplain etex jadetex latex lollipop mex
	mllatex mltex pdfetex pdfcslatex pdfcsplain pdfjadetex pdflatex
	pdfmex pdfxmltex texsis utf8mex xmltex"

do_configure(){
	echo ${PKGDESTDIR}
	case "$XBPS_TARGET_MACHINE" in
		ppc64*) EXTRA="--disable-luajittex --disable-mfluajit"
		;;
	esac
	#if [ "$CROSS_BUILD" ]; then
	#	EXTRA+=" --build=${XBPS_CROSS_TRIPLET}-"
	#	export LIBTOOL=libtool
	#fi
	
	cd ${wrksrc}/texlive-$version-source
	mkdir build 
	cd build
	../configure -C \
		--prefix=/usr \
		--sysconfdir=/etc \
		--mandir=/usr/share/man \
		--infodir=/usr/share/info \
		--localstatedir=/var \
		--enable-biber \
		--enable-epsfwin \
		--enable-ipc \
		--enable-luatex \
		--enable-mftalkwin \
		--enable-regiswin \
		--enable-shared \
		--enable-tektronixwin \
		--enable-unitermwin \
		--enable-xetex \
		--enable-dvipng \
		--enable-dvipsk \
		--enable-ps2eps \
		--enable-psutils \
		--enable-bibtex-x \
		--disable-chktex \
		--disable-cjkutils \
		--disable-detex \
		--disable-dialog \
		--disable-dvi2tty \
		--disable-dvisvgm \
		--disable-largefile \
		--disable-lcdf-typetools \
		--disable-multiplatform \
		--disable-native-texlive-build \
		--disable-pdfopen \
		--disable-ps2pkm \
		--disable-t1utils \
		--disable-tex4htk \
		--disable-ttf2pk2 \
		--disable-vlna \
		--disable-xindy \
		--with-ps=gs \
		--with-banner-add="/Void Linux" \
		--with-system-zlib \
		--with-system-zziplib \
		--without-texinfo \
		$EXTRA
}

do_build(){
	cd ${wrksrc}/texlive-$version-source/build
	make ${makejobs}
}
do_install(){
	cd ${wrksrc}/texlive-$version-source/build
	make DESTDIR=${DESTDIR} install
	cp -rf ../texk/tests/TeXLive \
		"$DESTDIR"/usr/share/texmf-dist/scripts/texlive
	
	local texcmd; for texcmd in $_pdftex; do
		ln -s pdftex "$DESTDIR"/usr/bin/$texcmd
	done
	ln -s eptex "$DESTDIR"/usr/bin/platex
	ln -s euptex "$DESTDIR"/usr/bin/uplatex
	sed -i -e 's:^\(TEXMFROOT *= *\)$SELFAUTOPARENT$:\1/usr/share:g' \
		"$DESTDIR"/usr/share/texmf-dist/web2c/texmf.cnf
	
}
